<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jessica</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' bot-resource: data:; img-src 'self' bot-resource: data:; media-src 'self' bot-resource: data:; style-src 'self' 'unsafe-inline'; script-src 'self'">

  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="vn-panel">
    <img id="vn-bg" />
    <div id="vn-sprite"></div><!-- legacy placeholder -->
  </div>

  <div id="resizer" aria-hidden="true"></div>

  <div id="main-body">
    <div id="toolbar" role="toolbar" aria-label="Chat toolbar">
      <button id="undo-btn" class="tool-btn" type="button" title="Undo Last Turn">&#x21B6; Undo</button>
      <button id="redo-btn" class="tool-btn" type="button" title="Regenerate Response">&#x21BB; Redo</button>
      <button id="reset-chat-btn" class="tool-btn" type="button" title="Reset Chat">&#x21BB; Reset</button>
      <div class="toolbar-group">
        <span class="toolbar-label">Thoughts</span>
        <div style="display:flex; align-items:center;">
          <select id="thoughts-char-select" class="tool-btn" style="padding-right: 30px;"></select>
          <button id="get-thoughts-btn" class="tool-btn" type="button" title="Get Character Thoughts">&#x1F9E0;</button>
          <button id="toggle-history-btn" class="tool-btn" type="button" title="Show/Hide Chat History">&#x1F4DC; History</button>
        </div>
      </div>
      <button id="options-btn" class="tool-btn" type="button" title="Settings" aria-haspopup="dialog">&#x2699;&#xFE0F; Options</button>
    </div>

    <!-- Spacer to push input area down -->
    <div style="flex:1;"></div>

    <div id="input-area" style="z-index: 100;">
      <textarea
        id="user-input"
        placeholder="Type your message... (Shift+Enter for new line)"
        aria-label="Message input"
      ></textarea>
      <button id="send-btn" type="button">Send</button>
      <button id="stop-btn" type="button" style="display:none;">Stop</button>
    </div>
  </div>

  <div id="history-overlay" class="hidden" style="display:none; z-index: 200;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:5px;">
          <h3 style="margin:0; color:#fff;">Chat History</h3>
          <button id="close-history-btn" class="close-btn" style="position:static; pointer-events:auto;">&times;</button>
      </div>
      <div id="chat-history" aria-live="polite" aria-label="Chat messages"></div>
  </div>

  <!-- Setup Modal -->
  <div id="setup-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="setup-title">
    <div class="modal-content">
      <h2 id="setup-title">Setup API</h2>

      <div class="form-group">
        <label for="setup-provider">Provider</label>
        <select id="setup-provider">
          <option value="gemini">Google Gemini</option>
          <option value="openai">OpenAI</option>
          <option value="openrouter">OpenRouter</option>
          <option value="grok">xAI (Grok)</option>
          <option value="chutes">Chutes.ai</option>
          <option value="featherless">Featherless.ai</option>
          <option value="local">Local LLM (LM Studio/Ollama)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="setup-key">API Key</label>
        <input type="password" id="setup-key" placeholder="Enter API Key" autocomplete="off" />
      </div>

      <div class="form-group">
        <label for="setup-model">Model (Optional)</label>
        <input type="text" id="setup-model" placeholder="e.g. gemini-1.5-flash" />
      </div>

      <div class="form-group" id="setup-base-url-group" style="display:none;">
        <label for="setup-base-url">Base URL</label>
        <input type="text" id="setup-base-url" placeholder="e.g. http://localhost:1234/v1" />
      </div>

      <div class="modal-footer">
        <button id="save-setup-btn" type="button" class="tool-btn primary">Save &amp; Start</button>
      </div>
    </div>
  </div>

  <!-- Options Modal -->
  <div id="options-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="options-title">
    <div class="modal-content">
      <button id="close-options-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="options-title">Options</h2>

      <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button id="save-chat-btn" class="tool-btn" type="button">&#x1F4BE; Save Chat</button>
        <button id="load-chat-btn" class="tool-btn" type="button">&#x1F4C2; Load Chat</button>
        <button id="summary-btn" class="tool-btn" type="button">&#x1F4DD; Summary</button>
        <button id="persona-btn" class="tool-btn" type="button">&#x1F464; Persona</button>
        <button id="lorebook-btn" class="tool-btn" type="button">&#x1F4D6; Lorebook</button>
      </div>

      <hr class="divider" />

      <div class="form-group">
        <label for="options-provider">Add/Update Key</label>
        <select id="options-provider">
          <option value="gemini">Google Gemini</option>
          <option value="openai">OpenAI</option>
          <option value="openrouter">OpenRouter</option>
          <option value="grok">xAI (Grok)</option>
          <option value="chutes">Chutes.ai</option>
          <option value="featherless">Featherless.ai</option>
          <option value="local">Local LLM (LM Studio/Ollama)</option>
        </select>
      </div>

      <div class="form-group">
        <input type="password" id="options-key" placeholder="New API Key" autocomplete="off" />
      </div>

      <div class="form-group">
        <input type="text" id="options-model" placeholder="Model ID (Optional)" />
      </div>

      <div class="form-group" id="options-base-url-group" style="display:none;">
        <input type="text" id="options-base-url" placeholder="Base URL (e.g. http://localhost:1234/v1)" />
      </div>

      <div class="form-group" style="display:flex; gap:10px;">
        <button id="update-key-btn" class="tool-btn" type="button" style="flex:1;">Update Key</button>
        <button id="test-provider-btn" class="tool-btn" type="button" style="flex:1;">Test Connection</button>
      </div>

      <hr class="divider" />

      <h3 style="margin-top:0;">Saved Keys</h3>
      <div id="keys-list"></div>

      <hr class="divider" />

      <div class="form-group">
        <button id="scan-images-btn" class="tool-btn" type="button" style="width:100%;">Rescan Images</button>
      </div>

      <div class="form-group">
        <label for="pollinations-key" style="display:block; margin-bottom:6px;">Pollinations Image Key (Optional)</label>
        <input type="password" id="pollinations-key" placeholder="Enter Pollinations key for reliable BG generation" autocomplete="off" />
        <div style="display:flex; gap:10px; margin-top:8px;">
          <button id="save-pollinations-key-btn" class="tool-btn" type="button" style="flex:1;">Save Image Key</button>
          <button id="clear-pollinations-key-btn" class="tool-btn danger" type="button" style="flex:1;">Clear Image Key</button>
        </div>
        <div id="pollinations-key-status" style="margin-top:6px; color:var(--text-muted); font-size:.85em;">Not configured</div>
        <div style="margin-top:6px; color:var(--text-dim); font-size:.82em; line-height:1.35;">
          Optional but recommended. A key improves reliability when anonymous requests are rate-limited.
        </div>
        <div style="margin-top:8px;">
          <button id="open-pollinations-key-help-btn" class="tool-btn" type="button" style="width:100%;">How to Get a Pollinations Key</button>
        </div>
      </div>

      <hr class="divider" />

      <h3 style="margin-top:0;">Token Usage (Estimate)</h3>
      <div class="form-group">
        <div style="display:flex; justify-content:space-between; color:var(--text-dim); font-size:.9em; margin-bottom:5px;">
          <span id="token-usage-text">0 / 128000</span>
          <span id="token-percentage">0%</span>
        </div>
        <div style="background:#444; height:10px; border-radius:5px; overflow:hidden;">
          <div id="token-bar" style="background:var(--accent); height:100%; width:0%; transition: width .3s;"></div>
        </div>
      </div>

      <hr class="divider" />

      <h3 style="margin-top:0;">Advanced Settings</h3>
      <div class="form-group">
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:10px;">
          <input type="checkbox" id="debug-toggle" />
          <span>Enable Visual Debug Overlay</span>
        </label>
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:10px;">
          <input type="checkbox" id="devtools-toggle" />
          <span>Enable Developer Tools</span>
        </label>
      </div>

      <div class="form-group">
        <button id="reset-voices-btn" class="tool-btn danger" type="button" style="width:100%;">Reset Character Voices</button>
        <button id="edit-voices-btn" class="tool-btn" type="button" style="width:100%; margin-top:10px;">Edit Voice Map</button>
      </div>

      <div class="form-group">
        <label for="advanced-temperature" style="display:flex; justify-content:space-between; color:var(--text-dim); font-size:.9em; margin-bottom:5px;">
          <span>Temperature (Creativity)</span>
          <span id="temp-display">0.7</span>
        </label>
        <input type="range" id="advanced-temperature" min="0" max="2" step="0.1" value="0.7" style="width:100%; cursor:pointer;" />
      </div>

      <div class="form-group">
        <label for="max-context">Max Context Limit</label>
        <input type="number" id="max-context" placeholder="e.g. 8192, 32000, 128000" />
      </div>

      <div class="form-group">
        <textarea id="advanced-prompt-content" rows="6" placeholder="Enter custom system instructions..."></textarea>
      </div>

      <div class="form-group">
        <button id="save-advanced-prompt-btn" class="tool-btn primary" type="button" style="width:100%;">Save Advanced Settings</button>
      </div>
    </div>
  </div>

  <!-- Persona Modal -->
  <div id="persona-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="persona-title">
    <div class="modal-content">
      <button id="close-persona-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="persona-title">User Persona</h2>

      <div class="form-group">
        <label for="persona-name">Name</label>
        <input type="text" id="persona-name" />
      </div>

      <div class="form-group">
        <label for="persona-details">Details / Appearance</label>
        <textarea id="persona-details" rows="5" placeholder="Describe yourself for the AI..."></textarea>
      </div>

      <div class="modal-footer">
        <button id="save-persona-btn" class="tool-btn primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Voice Map Modal -->
  <div id="voice-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="voice-title">
    <div class="modal-content">
      <button id="close-voice-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="voice-title">Voice Assignments</h2>
      <p style="font-size:.8em; color:#aaa; margin-top:-10px;">
        Manually assign Piper Speaker IDs (0-900).
      </p>
      <div id="voice-list" style="max-height:400px; overflow-y:auto; margin-bottom:15px;"></div>
      <div class="modal-footer">
        <button id="save-voice-btn" class="tool-btn primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Summary Modal -->
  <div id="summary-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="summary-title">
    <div class="modal-content">
      <button id="close-summary-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="summary-title">Story Summary</h2>
      <p style="font-size:.8em; color:#aaa; margin-top:-10px;">
        This is auto-generated to help the AI remember long conversations.
      </p>

      <div class="form-group">
        <textarea id="summary-content" rows="10"></textarea>
      </div>

      <div class="modal-footer">
        <button id="save-summary-btn" class="tool-btn primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Lorebook Modal -->
  <div id="lorebook-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="lorebook-title">
    <div class="modal-content" style="width:600px; max-width:90%;">
      <button id="close-lorebook-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="lorebook-title">Lorebook Editor</h2>
      <p style="font-size:.8em; color:#aaa; margin-top:-10px;">
        View and edit dynamic lore entries generated by the AI.
      </p>

      <div class="form-group">
        <textarea
          id="lorebook-content"
          rows="15"
          placeholder="[]"
          style="font-family:monospace; font-size:.9em; white-space:pre; overflow-x:auto;"
        ></textarea>
      </div>

      <div class="modal-footer">
        <button id="save-lorebook-btn" class="tool-btn primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Tree Modal -->
  <div id="tree-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="tree-title">
    <div class="modal-content" style="width: 90%; max-width: 1000px; height: 90vh;">
      <button id="close-tree-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="tree-title">Conversation Tree</h2>
      <p style="color:var(--text-muted); font-size:0.9em;">Click a node to switch to that version.</p>
      <div id="tree-viewer" style="padding: 20px; display: flex; flex-direction: column; align-items: center;"></div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <div class="modal-content" style="width:400px;">
      <h2 id="confirm-title">Confirm</h2>
      <p id="confirm-text" style="margin-bottom:20px; color:#ddd;"></p>

      <div class="modal-footer">
        <button id="confirm-cancel-btn" class="tool-btn" type="button">Cancel</button>
        <button id="confirm-yes-btn" class="tool-btn danger" type="button">Yes</button>
      </div>
    </div>
  </div>

  <!-- Load Chat Modal -->
  <div id="load-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="load-title">
    <div class="modal-content">
      <button id="close-load-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="load-title">Load Chat</h2>
      <div id="saved-chats-list" style="max-height:300px; overflow-y:auto;"></div>
    </div>
  </div>

  <!-- Generic Info Modal (for Inner Monologue) -->
  <div id="info-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="info-title">
    <div class="modal-content" style="width:500px;">
      <button id="close-info-btn" class="close-btn" type="button" aria-label="Close">&times;</button>
      <h2 id="info-title">Inner Monologue</h2>
      <p id="info-text" style="white-space: pre-wrap; line-height: 1.6; color: #ddd; max-height: 60vh; overflow-y: auto;"></p>
    </div>
  </div>

  <!-- Scripts (defer preserves order while not blocking HTML parsing) -->
  <script src="audio.js" defer></script>
  <script src="visuals.js" defer></script>
  <script src="ui.js" defer></script>
  <script src="settings-ui.js" defer></script>
  <script type="module" src="renderer.js" defer></script>
</body>
</html>

